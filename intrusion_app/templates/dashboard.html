{% load static %}
{% load alerts_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Info IDS | Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN (NO LOCAL FILE NEEDED) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>
@keyframes slideInToast {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>

<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-gray-800 text-white min-h-screen flex">

<!-- ================= SIDEBAR ================= -->
<aside
  class="w-64 bg-slate-900 p-6 border-r border-gray-700
         fixed left-0 top-0 h-screen
         flex flex-col">

  <!-- TOP (Scrollable Menu) -->
  <div class="flex-1 overflow-y-auto">
    <h1 class="text-2xl font-bold text-cyan-400 mb-6">Info IDS</h1>

    <nav class="space-y-4">
      <a href="/" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20 bg-cyan-500/20">üìä Dashboard</a>
      <a href="/#" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20">üì§ Upload Data</a>
      <a href="/#" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20">üìã Reports</a>
      {% if user_role == 'ADMIN' or user_role == 'ANALYST' %}
      <a href="/settings/" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20 transition-all duration-200">‚öôÔ∏è Settings</a>
      {% endif %}
    </nav>
  </div>

  <!-- BOTTOM USER PROFILE -->
  <div class="border-t border-gray-700 pt-4 mt-4 bg-slate-900">

    <div class="flex items-center gap-3 min-w-0">

      <!-- PROFILE IMAGE (FIXED) -->
      {% with user.socialaccount_set.first as social %}
        <img
          src="{% if social and social.get_avatar_url %}
                 {{ social.get_avatar_url }}
               {% else %}
                 {% static 'images/default-avatar.png' %}
               {% endif %}"
          alt="Profile"
          class="w-10 h-10 rounded-full border border-cyan-400
                 object-cover flex-shrink-0
                 hover:ring-2 hover:ring-cyan-400 transition"
        />
      {% endwith %}

      <!-- NAME / EMAIL -->
      <div class="text-sm min-w-0">
        <p class="font-semibold truncate max-w-[150px]">
          {% if user.get_full_name %}
            {{ user.get_full_name }}
          {% else %}
            {{ user.email }}
          {% endif %}
        </p>
        <p class="text-xs text-gray-400">Authenticated</p>
      </div>
    </div>

    <!-- LOGOUT -->
    <form method="post" action="{% url 'account_logout' %}" class="mt-4">
      {% csrf_token %}
      <button
        class="w-full text-left px-4 py-2 rounded-xl
               text-red-400 hover:bg-red-500/10 transition">
        Logout
      </button>
    </form>

  </div>
</aside>


<!-- ================= MAIN ================= -->
<main class="flex-1 p-6 space-y-8 ml-64">

<!-- Header -->
<header class="bg-slate-800 p-6 rounded-2xl text-center">
  <h2 class="text-4xl font-extrabold text-cyan-400">AI Intrusion Detection System</h2>
  <p class="text-gray-400">Real-Time Network Monitoring</p>
</header>

<!-- ================= STATS ================= -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-6">
  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400">Active Alerts</h3>
    <h2 id="activeAlerts" class="text-4xl font-bold">0</h2>
    <p class="text-sm text-gray-400">Last 24h</p>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400">Network Traffic</h3>
    <h2 id="networkTraffic" class="text-4xl font-bold">0 GB</h2>
    <p class="text-sm text-gray-400">Today</p>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400">Accuracy</h3>
    <h2 id="accuracy" class="text-4xl font-bold">97%</h2>
    <p class="text-sm text-gray-400">ML Model</p>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400">Uptime</h3>
    <h2 id="uptime" class="text-4xl font-bold">99.9%</h2>
    <p class="text-sm text-gray-400">This Week</p>
  </div>
</section>

<!-- ================= CHARTS ================= -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400 mb-4">Attack Distribution</h3>
    <canvas id="attackPie"></canvas>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400 mb-4">Alerts Over Time</h3>
    <canvas id="alertsLine"></canvas>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400 mb-4">Attack Types</h3>
    <canvas id="attackBar"></canvas>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400 mb-4">Threat Radar</h3>
    <canvas id="attackRadar"></canvas>
  </div>
</section>

<!-- ================= AI/ML ATTACK DETECTION ================= -->
<section class="bg-slate-800 p-6 rounded-2xl">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-cyan-400 text-lg font-bold">AI/ML Attack Detection</h3>
    <span id="detectionCountBadge" class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">0</span>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
    <div class="bg-slate-700 p-4 rounded-lg">
      <div class="text-gray-400 text-sm">Total Attacks (24h)</div>
      <div id="totalAttacks24h" class="text-2xl font-bold text-yellow-400">0</div>
    </div>
    <div class="bg-slate-700 p-4 rounded-lg">
      <div class="text-gray-400 text-sm">Avg AI Confidence</div>
      <div id="avgConfidence" class="text-2xl font-bold text-blue-400">0%</div>
    </div>
    <div class="bg-slate-700 p-4 rounded-lg">
      <div class="text-gray-400 text-sm">Critical Threats</div>
      <div id="criticalThreats" class="text-2xl font-bold text-red-400">0</div>
    </div>
  </div>
  
  <div id="attackDetectionList" class="space-y-2 max-h-96 overflow-y-auto">
    <div class="text-gray-400 text-center py-8">No attacks detected yet</div>
  </div>
</section>

<!-- ================= RECENT ALERTS & BLOCKED IPS ================= -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-slate-800 p-6 rounded-2xl">
    <h3 class="text-cyan-400 mb-4">Recent Alerts</h3>
    <ul id="recentAlertsList" class="space-y-2 text-sm text-gray-300 max-h-60 overflow-auto">
      <li>No alerts yet</li>
    </ul>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-cyan-400">Blocked IPs</h3>
      <span id="blockedCountBadge" class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">0</span>
    </div>
    <div id="blockedIPsContainer" class="space-y-3 max-h-80 overflow-y-auto">
      <div class="text-gray-400 text-center py-8">No blocked IPs</div>
    </div>
  </div>
</section>

<!-- ================= TOAST ================= -->
<!-- AI Intrusion Alert -->
<div id="aiToast"
     style="
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 360px;
        background: linear-gradient(145deg, #020617, #020617);
        color: white;
        padding: 18px 20px;
        border-radius: 18px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.6);
        border: 1.5px solid #ef4444;
        display: none;
        z-index: 9999;
        animation: slideInToast 0.35s ease-out;
     ">

    <!-- Header -->
    <div style="display:flex; align-items:center; gap:12px;">
        <div style="
            width:42px;
            height:42px;
            border-radius:50%;
            background:#ef4444;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:20px;
            font-weight:bold;
        ">
            !
        </div>

        <div>
            <h3 style="font-size:18px; font-weight:600; color:#f87171;">
                Intrusion Detected
            </h3>
            <p style="font-size:14px; color:#cbd5f5; margin-top:4px;">
                AI detected suspicious activity.
            </p>
        </div>
    </div>

    <!-- Divider -->
    <div style="height:1px; background:#1e293b; margin:14px 0;"></div>

    <!-- Actions -->
    <div style="display:flex; justify-content:flex-end; gap:12px;">
        <button onclick="closeToast()"
                style="
                    padding:8px 16px;
                    border-radius:10px;
                    background:#020617;
                    color:#e5e7eb;
                    border:1px solid #334155;
                    cursor:pointer;
                    transition:all 0.2s;
                "
                onmouseover="this.style.background='#020617'; this.style.borderColor='#64748b';"
                onmouseout="this.style.background='#020617'; this.style.borderColor='#334155';"
        >
            Close
        </button>

        <button onclick="acknowledgeAlert()"
                style="
                    padding:8px 18px;
                    border-radius:10px;
                    background:#ef4444;
                    color:white;
                    border:none;
                    cursor:pointer;
                    font-weight:600;
                    transition:all 0.2s;
                "
                onmouseover="this.style.background='#dc2626';"
                onmouseout="this.style.background='#ef4444';"
        >
            OK
        </button>
    </div>
</div>


</main>

<!-- Confirmation Modal (hidden by default) -->
<div id="confirmModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:99999;">
  <div style="background:#0b1220; padding:18px; border-radius:12px; width:420px;">
    <h3 id="confirmModalTitle" style="color:#f87171; font-size:18px; margin-bottom:8px;">Confirm</h3>
    <p id="confirmModalBody" style="color:#cbd5f5; margin-bottom:12px;">Are you sure?</p>
    <div style="display:flex; justify-content:flex-end; gap:8px;">
      <button id="confirmModalCancel" style="padding:8px 12px; border-radius:8px; background:#0b1220; color:#cbd5f5; border:1px solid #334155;">Cancel</button>
      <button id="confirmModalConfirm" style="padding:8px 12px; border-radius:8px; background:#ef4444; color:white;">Confirm</button>
    </div>
  </div>
</div>

<!-- ================= JS (REAL-TIME) ================= -->
<script>
// Get user permissions from Django context
const canModifyIPs = {{ can_modify_ips|lower }};
let pieChart, lineChart, barChart, radarChart;

function updateDashboard() {
  fetch('/dashboard-data/')
    .then(res => res.json())
    .then(data => {

      // Update stats
      activeAlerts.innerText = data.active_alerts;
      networkTraffic.innerText = data.traffic_gb + " GB";
      accuracy.innerText = data.accuracy + "%";
      uptime.innerText = data.uptime + "%";

      const labels = data.attack_distribution.map(i => i.attack_type);
      const values = data.attack_distribution.map(i => i.count);

      if (pieChart) pieChart.destroy();
      pieChart = new Chart(attackPie, { type:'pie', data:{labels,datasets:[{data:values}]} });

      if (barChart) barChart.destroy();
      barChart = new Chart(attackBar, { type:'bar', data:{labels,datasets:[{data:values}]} });

      if (radarChart) radarChart.destroy();
      radarChart = new Chart(attackRadar, { type:'radar', data:{labels,datasets:[{data:values}]} });

      const tLabels = data.alerts_over_time.map(i => i.hour);
      const tValues = data.alerts_over_time.map(i => i.count);

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(alertsLine, {
        type:'line',
        data:{labels:tLabels,datasets:[{data:tValues,label:'Alerts'}]}
      });

      // CSRF helper
      function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
      }

      // Confirmation modal utilities
      function showConfirmModal(title, message, dataAttrs) {
        const modal = document.getElementById('confirmModal');
        document.getElementById('confirmModalTitle').innerText = title;
        document.getElementById('confirmModalBody').innerText = message;
        const btn = document.getElementById('confirmModalConfirm');
        // attach data attributes
        btn.dataset.params = JSON.stringify(dataAttrs || {});
        modal.style.display = 'flex';
      }

      function hideConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.style.display = 'none';
      }

      const blockedSet = new Set((data.blocked_ips || []).map(b => b.ip));

      // Recent alerts panel (show checkbox to block if alert has source and user is authorized)
      const recentAlertsList = document.getElementById('recentAlertsList');
      recentAlertsList.innerHTML = '';
      if (data.recent_alerts && data.recent_alerts.length) {
        data.recent_alerts.forEach(a => {
          const li = document.createElement('li');
          const src = a.source || 'unknown';
          const text = document.createElement('span');
          text.innerText = `${a.type || 'Alert'} ‚Äî ${src} ${a.timestamp? '('+a.timestamp+')':''}`;

          li.appendChild(text);

          // Only show block checkbox if user can modify IPs
          if (src !== 'unknown' && canModifyIPs) {
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.style.marginLeft = '12px';
            cb.checked = blockedSet.has(src);
            cb.onchange = function() {
              const checked = cb.checked;
              const url = checked ? '/block-ip/' : '/unblock-ip/';
              const reason = a.type || 'detected';
              // if OS blocking is enabled, require confirmation modal
              if (data.os_blocking_enabled) {
                const action = checked ? 'Block' : 'Unblock';
                showConfirmModal(action + ' IP', `${action} ${src} at OS level? This will modify the host firewall.`, {url, ip: src, checked, reason});
              } else {
                const form = new FormData();
                form.append('ip', src);
                if (checked) form.append('reason', reason);
                fetch(url, {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                  .then(r => r.json())
                  .then(j => {
                    if (!j.ok) { alert('Action failed: ' + (j.error || 'unknown')); cb.checked = !checked; }
                    else { updateBlockedIPs(src, checked, reason); }
                  }).catch(e => { alert('Request failed'); cb.checked = !checked; });
              }
            };
            li.appendChild(cb);
          }

          recentAlertsList.appendChild(li);
        });
      } else {
        recentAlertsList.innerHTML = '<li>No alerts yet</li>';
      }

      // Blocked IPs panel - with action buttons for admin/analyst
      const blockedIPsContainer = document.getElementById('blockedIPsContainer');
      blockedIPsContainer.innerHTML = '';
      
      if (data.blocked_ips && data.blocked_ips.length) {
        document.getElementById('blockedCountBadge').innerText = data.blocked_ips.length;
        
        data.blocked_ips.forEach(b => {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'background:rgba(30,41,59,0.6); padding:12px; border-radius:10px; border-left:3px solid #ef4444; display:flex; justify-content:space-between; align-items:center;';
          
          // IP Info Section
          const infoDiv = document.createElement('div');
          infoDiv.style.cssText = 'flex:1; min-width:0;';
          
          const ipSpan = document.createElement('div');
          ipSpan.style.cssText = 'font-weight:bold; color:#fbbf24; word-break:break-all;';
          ipSpan.innerText = b.ip;
          infoDiv.appendChild(ipSpan);
          
          const reasonSpan = document.createElement('div');
          reasonSpan.style.cssText = 'font-size:12px; color:#9ca3af; margin-top:4px;';
          reasonSpan.innerText = `Reason: ${b.reason || 'manual'} ‚Äî ${b.created_at? new Date(b.created_at).toLocaleDateString() : 'unknown'}`;
          infoDiv.appendChild(reasonSpan);
          
          itemDiv.appendChild(infoDiv);
          
          // Action Buttons (only for admin/analyst)
          if (canModifyIPs) {
            const actionDiv = document.createElement('div');
            actionDiv.style.cssText = 'display:flex; gap:6px; margin-left:12px;';
            
            // Unblock Button
            const unblockBtn = document.createElement('button');
            unblockBtn.innerText = 'Unblock';
            unblockBtn.style.cssText = 'background:#10b981; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:12px; font-weight:bold; transition:background 0.2s;';
            unblockBtn.onmouseover = () => unblockBtn.style.background = '#059669';
            unblockBtn.onmouseout = () => unblockBtn.style.background = '#10b981';
            unblockBtn.onclick = () => {
              if (data.os_blocking_enabled) {
                showConfirmModal('Unblock IP', `Remove OS-level block for ${b.ip}?`, {url:'/unblock-ip/', ip: b.ip, checked:false});
              } else {
                const form = new FormData();
                form.append('ip', b.ip);
                fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                  .then(r => r.json())
                  .then(j => {
                    if (j.ok) { 
                      itemDiv.style.opacity = '0.5';
                      setTimeout(() => itemDiv.remove(), 300);
                      updateBlockedIPCount();
                    } else { 
                      alert('Unblock failed: ' + (j.error || 'unknown')); 
                    }
                  })
                  .catch(e => { alert('Request failed'); });
              }
            };
            actionDiv.appendChild(unblockBtn);
            
            // Close Button
            const closeBtn = document.createElement('button');
            closeBtn.innerText = '‚úï';
            closeBtn.style.cssText = 'background:#6b7280; color:white; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; font-size:14px; font-weight:bold; transition:background 0.2s;';
            closeBtn.onmouseover = () => closeBtn.style.background = '#4b5563';
            closeBtn.onmouseout = () => closeBtn.style.background = '#6b7280';
            closeBtn.onclick = () => {
              const form = new FormData();
              form.append('ip', b.ip);
              fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                .then(r => r.json())
                .then(j => {
                  if (j.ok) {
                    itemDiv.style.transform = 'slideOut';
                    itemDiv.style.opacity = '0';
                    setTimeout(() => itemDiv.remove(), 200);
                    updateBlockedIPCount();
                  }
                })
                .catch();
            };
            actionDiv.appendChild(closeBtn);
            
            itemDiv.appendChild(actionDiv);
          }
          
          blockedIPsContainer.appendChild(itemDiv);
        });
      } else {
        document.getElementById('blockedCountBadge').innerText = '0';
        blockedIPsContainer.innerHTML = '<div class="text-gray-400 text-center py-8">No blocked IPs</div>';
      }
      
      function updateBlockedIPCount() {
        const count = blockedIPsContainer.querySelectorAll('[style*="background:rgba"]').length;
        document.getElementById('blockedCountBadge').innerText = count;
        if (count === 0) {
          blockedIPsContainer.innerHTML = '<div class="text-gray-400 text-center py-8">No blocked IPs</div>';
        }
      }

      function updateBlockedIPs(ip, add, reason) {
        const blockedIPsContainer = document.getElementById('blockedIPsContainer');
        const countBadge = document.getElementById('blockedCountBadge');
        
        if (add) {
          // Add new blocked IP to the top
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'background:rgba(30,41,59,0.6); padding:12px; border-radius:10px; border-left:3px solid #ef4444; display:flex; justify-content:space-between; align-items:center;';
          
          const infoDiv = document.createElement('div');
          infoDiv.style.cssText = 'flex:1; min-width:0;';
          
          const ipSpan = document.createElement('div');
          ipSpan.style.cssText = 'font-weight:bold; color:#fbbf24; word-break:break-all;';
          ipSpan.innerText = ip;
          infoDiv.appendChild(ipSpan);
          
          const reasonSpan = document.createElement('div');
          reasonSpan.style.cssText = 'font-size:12px; color:#9ca3af; margin-top:4px;';
          reasonSpan.innerText = `Reason: ${reason || 'detected'} ‚Äî ${new Date().toLocaleDateString()}`;
          infoDiv.appendChild(reasonSpan);
          
          itemDiv.appendChild(infoDiv);
          
          if (canModifyIPs) {
            const actionDiv = document.createElement('div');
            actionDiv.style.cssText = 'display:flex; gap:6px; margin-left:12px;';
            
            const unblockBtn = document.createElement('button');
            unblockBtn.innerText = 'Unblock';
            unblockBtn.style.cssText = 'background:#10b981; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:12px; font-weight:bold;';
            unblockBtn.onclick = () => {
              const form = new FormData();
              form.append('ip', ip);
              fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                .then(r => r.json())
                .then(j => { if (j.ok) { itemDiv.remove(); updateBlockedIPCount(); } })
                .catch();
            };
            actionDiv.appendChild(unblockBtn);
            
            const closeBtn = document.createElement('button');
            closeBtn.innerText = '‚úï';
            closeBtn.style.cssText = 'background:#6b7280; color:white; padding:6px 10px; border-radius:6px; border:none; cursor:pointer;';
            closeBtn.onclick = () => {
              const form = new FormData();
              form.append('ip', ip);
              fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                .then(r => r.json())
                .then(j => { if (j.ok) { itemDiv.remove(); updateBlockedIPCount(); } })
                .catch();
            };
            actionDiv.appendChild(closeBtn);
            itemDiv.appendChild(actionDiv);
          }
          
          blockedIPsContainer.prepend(itemDiv);
          if (blockedIPsContainer.querySelector('.text-gray-400')) {
            blockedIPsContainer.querySelector('.text-gray-400').remove();
          }
          updateBlockedIPCount();
        } else {
          // Remove IP from list
          const items = Array.from(blockedIPsContainer.querySelectorAll('div'));
          items.forEach(item => {
            const ipDiv = item.querySelector('[style*="color:#fbbf24"]');
            if (ipDiv && ipDiv.innerText === ip) {
              item.remove();
            }
          });
          updateBlockedIPCount();
        }
      }

      // Render AI/ML Attack Detections
      const attackDetectionList = document.getElementById('attackDetectionList');
      attackDetectionList.innerHTML = '';
      
      if (data.attack_detections && data.attack_detections.length) {
        document.getElementById('detectionCountBadge').innerText = data.attack_detections.length;
        
        // Calculate statistics
        let totalAttacks = data.attack_detections.length;
        let criticalCount = 0;
        let totalConfidence = 0;
        
        data.attack_detections.forEach(attack => {
          if (attack.severity === 'CRITICAL') criticalCount++;
          totalConfidence += attack.confidence_score;
          
          const attackDiv = document.createElement('div');
          attackDiv.style.cssText = 'background:rgba(30,41,59,0.8); padding:12px; border-radius:8px; border-left:4px solid; margin-bottom:8px;';
          
          // Determine color based on severity
          const severityColors = {
            'CRITICAL': '#ef4444',
            'HIGH': '#f97316',
            'MEDIUM': '#eab308',
            'LOW': '#3b82f6'
          };
          attackDiv.style.borderColor = severityColors[attack.severity] || '#3b82f6';
          
          // Build attack info
          const infoHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div style="flex:1;">
                <div style="font-weight:bold; color:${severityColors[attack.severity]}; margin-bottom:4px;">
                  ${attack.attack_type} - ${attack.severity}
                </div>
                <div style="font-size:12px; color:#9ca3af; margin-bottom:4px;">
                  Source: <span style="color:#fbbf24; font-weight:bold;">${attack.source_ip || 'N/A'}</span>
                  ${attack.port ? '| Port: ' + attack.port : ''}
                </div>
                <div style="font-size:11px; color:#6b7280;">
                  Model: ${attack.ai_model || 'Unknown'} | Time: ${new Date(attack.detected_at).toLocaleTimeString()}
                </div>
              </div>
              <div style="text-align:right;">
                <div style="background:#1e293b; padding:6px 10px; border-radius:6px; color:#60a5fa; font-weight:bold; font-size:12px;">
                  ${(attack.confidence_score * 100).toFixed(1)}% Confidence
                </div>
              </div>
            </div>
          `;
          
          attackDiv.innerHTML = infoHTML;
          attackDetectionList.appendChild(attackDiv);
        });
        
        // Update statistics
        document.getElementById('totalAttacks24h').innerText = totalAttacks;
        document.getElementById('avgConfidence').innerText = ((totalConfidence / totalAttacks) * 100).toFixed(1) + '%';
        document.getElementById('criticalThreats').innerText = criticalCount;
      } else {
        document.getElementById('detectionCountBadge').innerText = '0';
        document.getElementById('totalAttacks24h').innerText = '0';
        document.getElementById('avgConfidence').innerText = '0%';
        document.getElementById('criticalThreats').innerText = '0';
        attackDetectionList.innerHTML = '<div class="text-gray-400 text-center py-8">No attacks detected yet</div>';
      }

      // Confirm modal button handlers
      document.getElementById('confirmModalConfirm').onclick = function() {
        const btn = document.getElementById('confirmModalConfirm');
        const params = JSON.parse(btn.dataset.params || '{}');
        const url = params.url;
        const ip = params.ip;
        const checked = params.checked;
        const reason = params.reason || '';
        const form = new FormData(); form.append('ip', ip); if (checked) form.append('reason', reason);
        fetch(url, {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
          .then(r => r.json()).then(j => {
            if (!j.ok) { alert('Action failed: ' + (j.error || 'unknown')); }
            else { updateBlockedIPs(ip, checked, reason); }
          }).catch(e => { alert('Request failed'); })
          .finally(() => hideConfirmModal());
      };
      document.getElementById('confirmModalCancel').onclick = function() { hideConfirmModal(); };
    });
}

// AI detection
function showToast(){ aiToast.style.display="block"; }
function closeToast(){ aiToast.style.display="none"; }
function acknowledgeAlert(){ closeToast(); }

setInterval(() => {
    fetch('/ai-check/')
    .then(res => res.json())
    .then(data => {
        if (data.prediction === "ATTACK") {
            showToast();
        }

        document.getElementById("activeAlerts").innerText = data.alerts;
        document.getElementById("networkTraffic").innerText = data.traffic + " GB";
    });
}, 5000);

updateDashboard();
setInterval(updateDashboard, 5000);

// WebSocket real-time updates
(function(){
  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(protocol + '://' + window.location.host + '/ws/alerts/');
  ws.onopen = () => console.log('ws open');
  ws.onmessage = (evt) => {
    try {
      const data = JSON.parse(evt.data);
      // If new alert, prepend to recent alerts
      if (data && data.attack_type) {
        const recentAlertsList = document.getElementById('recentAlertsList');
        const li = document.createElement('li');
        const src = data.source || 'unknown';
        li.innerText = `${data.attack_type} ‚Äî ${src} (${data.timestamp || new Date().toISOString()})`;
        // add checkbox for blocking
        if (src !== 'unknown') {
          const cb = document.createElement('input'); cb.type='checkbox'; cb.style.marginLeft='12px';
          cb.onchange = function(){ /* user can use existing UI to block */ };
          li.appendChild(cb);
        }
        recentAlertsList.prepend(li);
        // also update activeAlerts counter
        const el = document.getElementById('activeAlerts');
        if (el) el.innerText = parseInt(el.innerText || '0') + 1;
      }
      // If blocked event, update blocked IPs
      if (data && data.blocked && data.source) {
        const blockedIPsList = document.getElementById('blockedIPsList');
        const li = document.createElement('li');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.style.marginRight='8px';
        const span = document.createElement('span'); span.innerText = `${data.source} ‚Äî blocked (${new Date().toISOString()})`;
        li.appendChild(cb); li.appendChild(span);
        blockedIPsList.prepend(li);
      }
    } catch(e) { console.error('ws msg err', e); }
  };
  ws.onclose = () => console.log('ws closed');
})();
</script>

</body>
</html>
