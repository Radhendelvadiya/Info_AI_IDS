{% load static %}
{% load alerts_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Info IDS | Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js CDN (NO LOCAL FILE NEEDED) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>
@keyframes slideInToast {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.card-hover { transition: all 0.3s ease; }
.card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(6, 182, 212, 0.2); }
</style>

<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-gray-800 text-white min-h-screen flex">

<!-- ================= SIDEBAR ================= -->
<aside
  class="w-64 bg-slate-900 p-6 border-r border-gray-700
         fixed left-0 top-0 h-screen
         flex flex-col">

  <!-- TOP (Scrollable Menu) -->
  <div class="flex-1 overflow-y-auto">
    <h1 class="text-2xl font-bold text-cyan-400 mb-6">Info IDS</h1>

    <nav class="space-y-4">
      <a href="/" class="block px-4 py-3 rounded-xl bg-cyan-500/20 border-l-4 border-cyan-400 transition-all duration-200">Dashboard</a>
      <a href="/#" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20 transition-all duration-200">Upload Data</a>
      <a href="/#" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20 transition-all duration-200">Reports</a>
      {% if user_role == 'ADMIN' or user_role == 'ANALYST' %}
      <a href="/user-management/" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20 transition-all duration-200">User Management</a>
      <a href="/settings/" class="block px-4 py-3 rounded-xl hover:bg-cyan-500/20 transition-all duration-200">Settings</a>
      {% endif %}
    </nav>
  </div>

  <!-- BOTTOM USER PROFILE -->
  <div class="border-t border-gray-700 pt-4 mt-4">

    <div class="flex items-center gap-3 min-w-0">

      <!-- PROFILE IMAGE (FIXED) -->
      {% with user.socialaccount_set.first as social %}
        <img
          src="{% if social and social.get_avatar_url %}
                 {{ social.get_avatar_url }}
               {% else %}
                 {% static 'images/default-avatar.png' %}
               {% endif %}"
          alt="Profile"
          class="w-10 h-10 rounded-full border border-cyan-400
                 object-cover flex-shrink-0
                 hover:ring-2 hover:ring-cyan-400 transition"
        />
      {% endwith %}

      <!-- NAME / EMAIL -->
      <div class="text-sm min-w-0">
        <p class="font-semibold truncate max-w-[150px]">
          {% if user.get_full_name %}
            {{ user.get_full_name }}
          {% else %}
            {{ user.email }}
          {% endif %}
        </p>
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold mt-1
          {% if user_role == 'ADMIN' %} bg-red-600/30 text-red-200 border border-red-500
          {% elif user_role == 'ANALYST' %} bg-yellow-600/30 text-yellow-200 border border-yellow-500
          {% else %} bg-blue-600/30 text-blue-200 border border-blue-500 {% endif %}">
          {% if user_role == 'ADMIN' %}<i class="fas fa-crown"></i>{% elif user_role == 'ANALYST' %}<i class="fas fa-magnifying-glass"></i>{% else %}<i class="fas fa-eye"></i>{% endif %}
          {{ user_role|title }}
        </span>
      </div>
    </div>

    <!-- LOGOUT -->
    <form method="post" action="{% url 'account_logout' %}" class="mt-4">
      {% csrf_token %}
      <button
        class="w-full text-left px-4 py-2 rounded-xl
               text-red-400 hover:bg-red-500/10 transition">
        Logout
      </button>
    </form>

  </div>
</aside>


<!-- ================= MAIN ================= -->
<main class="flex-1 p-6 space-y-8 ml-64">

<!-- Header -->
<header class="bg-slate-800 p-6 rounded-2xl text-center border border-gray-700">
  <h2 class="text-4xl font-extrabold text-cyan-400">AI Intrusion Detection System</h2>
  <p class="text-gray-400 mt-2">Real-Time Network Monitoring & Threat Prevention</p>
</header>

<!-- ================= STATS ================= -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-6">
  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-cyan-400 font-semibold text-sm uppercase">Active Alerts</h3>
      <i class="fas fa-bell text-xl text-cyan-400"></i>
    </div>
    <h2 id="activeAlerts" class="text-4xl font-bold text-red-400">0</h2>
    <p class="text-xs text-gray-400 mt-2">Last 24 hours</p>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-cyan-400 font-semibold text-sm uppercase">Network Traffic</h3>
      <i class="fas fa-wifi text-xl text-cyan-400"></i>
    </div>
    <h2 id="networkTraffic" class="text-4xl font-bold text-blue-400">0 GB</h2>
    <p class="text-xs text-gray-400 mt-2">Today</p>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-cyan-400 font-semibold text-sm uppercase">Accuracy</h3>
      <i class="fas fa-crosshairs text-xl text-cyan-400"></i>
    </div>
    <h2 id="accuracy" class="text-4xl font-bold text-green-400">97%</h2>
    <p class="text-xs text-gray-400 mt-2">ML Model</p>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-cyan-400 font-semibold text-sm uppercase">Uptime</h3>
      <i class="fas fa-check-circle text-xl text-cyan-400"></i>
    </div>
    <h2 id="uptime" class="text-4xl font-bold text-emerald-400">99.9%</h2>
    <p class="text-xs text-gray-400 mt-2">This Week</p>
  </div>
</section>

<!-- ================= CHARTS ================= -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-fan text-cyan-400"></i>
      <h3 class="text-cyan-400 font-bold">Attack Distribution</h3>
    </div>
    <canvas id="attackPie"></canvas>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-chart-line text-cyan-400"></i>
      <h3 class="text-cyan-400 font-bold">Alerts Over Time</h3>
    </div>
    <canvas id="alertsLine"></canvas>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-bars text-cyan-400"></i>
      <h3 class="text-cyan-400 font-bold">Attack Types</h3>
    </div>
    <canvas id="attackBar"></canvas>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-radar text-cyan-400"></i>
      <h3 class="text-cyan-400 font-bold">Threat Radar</h3>
    </div>
    <canvas id="attackRadar"></canvas>
  </div>
</section>

<!-- ================= AI/ML ATTACK DETECTION ================= -->
<section class="bg-slate-800 p-6 rounded-2xl border border-gray-700">
  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-2">
      <i class="fas fa-brain text-cyan-400 text-xl"></i>
      <h3 class="text-cyan-400 text-lg font-bold">AI/ML Attack Detection</h3>
    </div>
    <span id="detectionCountBadge" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">0</span>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
    <div class="bg-slate-700 p-4 rounded-lg border border-gray-600">
      <div class="flex items-center gap-2 mb-2">
        <i class="fas fa-hourglass text-yellow-400"></i>
        <div class="text-gray-400 text-xs uppercase tracking-wider">Total Attacks (24h)</div>
      </div>
      <div id="totalAttacks24h" class="text-3xl font-bold text-yellow-400">0</div>
    </div>
    <div class="bg-slate-700 p-4 rounded-lg border border-gray-600">
      <div class="flex items-center gap-2 mb-2">
        <i class="fas fa-percentage text-blue-400"></i>
        <div class="text-gray-400 text-xs uppercase tracking-wider">Avg AI Confidence</div>
      </div>
      <div id="avgConfidence" class="text-3xl font-bold text-blue-400">0%</div>
    </div>
    <div class="bg-slate-700 p-4 rounded-lg border border-gray-600">
      <div class="flex items-center gap-2 mb-2">
        <i class="fas fa-triangle-exclamation text-red-400"></i>
        <div class="text-gray-400 text-xs uppercase tracking-wider">Critical Threats</div>
      </div>
      <div id="criticalThreats" class="text-3xl font-bold text-red-400">0</div>
    </div>
  </div>
  
  <div id="attackDetectionList" class="space-y-2 max-h-96 overflow-y-auto">
    <div class="text-gray-400 text-center py-8"><i class="fas fa-shield-check text-green-400 text-2xl mb-2 block"></i>No attacks detected yet</div>
  </div>
</section>

<!-- ================= RECENT ALERTS & BLOCKED IPS ================= -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-triangle-exclamation text-yellow-400"></i>
      <h3 class="text-cyan-400 font-bold">Recent Alerts</h3>
    </div>
    <ul id="recentAlertsList" class="space-y-2 text-sm text-gray-300 max-h-60 overflow-auto">
      <li class="text-center text-gray-400 py-4">No alerts yet</li>
    </ul>
  </div>

  <div class="bg-slate-800 p-6 rounded-2xl border border-gray-700 card-hover">
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center gap-2">
        <i class="fas fa-ban text-red-400"></i>
        <h3 class="text-cyan-400 font-bold">Blocked IPs</h3>
      </div>
      <span id="blockedCountBadge" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">0</span>
    </div>
    <div id="blockedIPsContainer" class="space-y-3 max-h-80 overflow-y-auto">
      <div class="text-gray-400 text-center py-8">No blocked IPs</div>
    </div>
  </div>
</section>

<!-- ================= USER & ROLE MANAGEMENT (Admin & Analyst Only) ================= -->
{% if user_role == 'ADMIN' or user_role == 'ANALYST' %}
<section class="bg-slate-800 p-6 rounded-2xl border border-gray-700">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-2">
      <i class="fas fa-users text-cyan-400 text-xl"></i>
      <h2 class="text-2xl font-bold text-cyan-400">User & Role Management</h2>
    </div>
    <span class="px-3 py-1 rounded-full text-xs font-bold bg-cyan-500/20 text-cyan-300 border border-cyan-400">Management</span>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- User List -->
    <div class="bg-slate-700 p-6 rounded-xl border border-gray-600 card-hover">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center text-blue-400 text-lg"><i class="fas fa-user-group"></i></div>
        <div>
          <h3 class="font-bold text-white">Active Users</h3>
          <p class="text-xs text-gray-400">Manage system users</p>
        </div>
      </div>
      
      <div id="usersList" class="space-y-3">
        <div class="text-center text-gray-400 py-4">
          <i class="fas fa-spinner text-xl animate-spin"></i>
          <p class="mt-2">Loading users...</p>
        </div>
      </div>
    </div>

    <!-- Role Assignment -->
    <div class="bg-slate-700 p-6 rounded-xl border border-gray-600 card-hover">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center text-purple-400 text-lg"><i class="fas fa-shield-alt"></i></div>
        <div>
          <h3 class="font-bold text-white">Add New User</h3>
          <p class="text-xs text-gray-400">Assign roles and permissions</p>
        </div>
      </div>
      
      <div class="space-y-3">
        <input type="email" id="newUserEmail" placeholder="Enter user email" class="w-full bg-slate-600 border border-gray-500 text-white py-2 px-3 rounded-lg focus:outline-none focus:border-cyan-400">
        
        <select id="newUserRole" class="w-full bg-slate-600 border border-gray-500 text-white py-2 px-3 rounded-lg focus:outline-none focus:border-cyan-400">
          <option value="">Select Role</option>
          <option value="ADMIN">Admin (Full Access)</option>
          <option value="ANALYST">Analyst (Manage Users & Access)</option>
          {% if user_role == 'ADMIN' %}
          <option value="VIEWER">Viewer (View Only)</option>
          {% endif %}
        </select>
        
        {% if user_role == 'ADMIN' %}
        <button onclick="addNewUser()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-4 rounded-lg transition transform hover:scale-105 duration-200">
          <i class="fas fa-plus mr-2"></i>Add User
        </button>
        {% else %}
        <button onclick="addNewUser()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-4 rounded-lg transition transform hover:scale-105 duration-200">
          <i class="fas fa-plus mr-2"></i>Add Analyst/Viewer
        </button>
        {% endif %}
        
        <p class="text-gray-400 text-xs mt-2">
          {% if user_role == 'ADMIN' %}
          As Admin, you can assign any role to users.
          {% else %}
          As Analyst, you can assign Analyst and Viewer roles only.
          {% endif %}
        </p>
      </div>
    </div>
  </div>

  <!-- Role Permissions Info -->
  <div class="mt-6 p-4 bg-slate-600/50 rounded-lg border border-gray-600">
    <h4 class="text-cyan-400 font-bold mb-3 flex items-center"><i class="fas fa-info-circle mr-2"></i>Role Permissions</h4>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
      <div>
        <span class="inline-block px-2 py-1 rounded bg-red-600/30 text-red-200 border border-red-500 font-bold mb-1">Admin</span>
        <p class="text-gray-300">✓ Full system access</p>
        <p class="text-gray-300">✓ Django admin panel</p>
        <p class="text-gray-300">✓ User management</p>
      </div>
      <div>
        <span class="inline-block px-2 py-1 rounded bg-yellow-600/30 text-yellow-200 border border-yellow-500 font-bold mb-1">Analyst</span>
        <p class="text-gray-300">✓ Dashboard access</p>
        <p class="text-gray-300">✓ Manage users</p>
        <p class="text-gray-300">✗ No Admin/Analyst creation</p>
      </div>
      <div>
        <span class="inline-block px-2 py-1 rounded bg-blue-600/30 text-blue-200 border border-blue-500 font-bold mb-1">Viewer</span>
        <p class="text-gray-300">✓ View dashboard</p>
        <p class="text-gray-300">✓ Analyze data</p>
        <p class="text-gray-300">✗ No modifications</p>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- ================= TOAST ================= -->
<!-- AI Intrusion Alert -->
<div id="aiToast"
     style="
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 360px;
        background: linear-gradient(145deg, #020617, #020617);
        color: white;
        padding: 18px 20px;
        border-radius: 18px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.6);
        border: 1.5px solid #ef4444;
        display: none;
        z-index: 9999;
        animation: slideInToast 0.35s ease-out;
     ">

    <!-- Header -->
    <div style="display:flex; align-items:center; gap:12px;">
        <div style="
            width:42px;
            height:42px;
            border-radius:50%;
            background:#ef4444;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:20px;
            font-weight:bold;
        ">
            !
        </div>

        <div>
            <h3 style="font-size:18px; font-weight:600; color:#f87171;">
                Intrusion Detected
            </h3>
            <p style="font-size:14px; color:#cbd5f5; margin-top:4px;">
                AI detected suspicious activity.
            </p>
        </div>
    </div>

    <!-- Divider -->
    <div style="height:1px; background:#1e293b; margin:14px 0;"></div>

    <!-- Actions -->
    <div style="display:flex; justify-content:flex-end; gap:12px;">
        <button onclick="closeToast()"
                style="
                    padding:8px 16px;
                    border-radius:10px;
                    background:#020617;
                    color:#e5e7eb;
                    border:1px solid #334155;
                    cursor:pointer;
                    transition:all 0.2s;
                "
                onmouseover="this.style.background='#020617'; this.style.borderColor='#64748b';"
                onmouseout="this.style.background='#020617'; this.style.borderColor='#334155';"
        >
            Close
        </button>

        <button onclick="acknowledgeAlert()"
                style="
                    padding:8px 18px;
                    border-radius:10px;
                    background:#ef4444;
                    color:white;
                    border:none;
                    cursor:pointer;
                    font-weight:600;
                    transition:all 0.2s;
                "
                onmouseover="this.style.background='#dc2626';"
                onmouseout="this.style.background='#ef4444';"
        >
            OK
        </button>
    </div>
</div>


</main>

<!-- Confirmation Modal (hidden by default) -->
<div id="confirmModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:99999;">
  <div style="background:#0b1220; padding:18px; border-radius:12px; width:420px;">
    <h3 id="confirmModalTitle" style="color:#f87171; font-size:18px; margin-bottom:8px;">Confirm</h3>
    <p id="confirmModalBody" style="color:#cbd5f5; margin-bottom:12px;">Are you sure?</p>
    <div style="display:flex; justify-content:flex-end; gap:8px;">
      <button id="confirmModalCancel" style="padding:8px 12px; border-radius:8px; background:#0b1220; color:#cbd5f5; border:1px solid #334155;">Cancel</button>
      <button id="confirmModalConfirm" style="padding:8px 12px; border-radius:8px; background:#ef4444; color:white;">Confirm</button>
    </div>
  </div>
</div>

<!-- ================= JS (REAL-TIME) ================= -->
<script>
// Get user permissions from Django context
const canModifyIPs = {{ can_modify_ips|lower }};
let pieChart, lineChart, barChart, radarChart;

function updateDashboard() {
  fetch('/dashboard-data/')
    .then(res => res.json())
    .then(data => {

      // Update stats
      activeAlerts.innerText = data.active_alerts;
      networkTraffic.innerText = data.traffic_gb + " GB";
      accuracy.innerText = data.accuracy + "%";
      uptime.innerText = data.uptime + "%";

      const labels = data.attack_distribution.map(i => i.attack_type);
      const values = data.attack_distribution.map(i => i.count);

      if (pieChart) pieChart.destroy();
      pieChart = new Chart(attackPie, { type:'pie', data:{labels,datasets:[{data:values}]} });

      if (barChart) barChart.destroy();
      barChart = new Chart(attackBar, { type:'bar', data:{labels,datasets:[{data:values}]} });

      if (radarChart) radarChart.destroy();
      radarChart = new Chart(attackRadar, { type:'radar', data:{labels,datasets:[{data:values}]} });

      const tLabels = data.alerts_over_time.map(i => i.hour);
      const tValues = data.alerts_over_time.map(i => i.count);

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(alertsLine, {
        type:'line',
        data:{labels:tLabels,datasets:[{data:tValues,label:'Alerts'}]}
      });

      // CSRF helper
      function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
      }

      // Confirmation modal utilities
      function showConfirmModal(title, message, dataAttrs) {
        const modal = document.getElementById('confirmModal');
        document.getElementById('confirmModalTitle').innerText = title;
        document.getElementById('confirmModalBody').innerText = message;
        const btn = document.getElementById('confirmModalConfirm');
        // attach data attributes
        btn.dataset.params = JSON.stringify(dataAttrs || {});
        modal.style.display = 'flex';
      }

      function hideConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.style.display = 'none';
      }

      const blockedSet = new Set((data.blocked_ips || []).map(b => b.ip));

      // Recent alerts panel (show checkbox to block if alert has source and user is authorized)
      const recentAlertsList = document.getElementById('recentAlertsList');
      recentAlertsList.innerHTML = '';
      if (data.recent_alerts && data.recent_alerts.length) {
        data.recent_alerts.forEach(a => {
          const li = document.createElement('li');
          const src = a.source || 'unknown';
          const text = document.createElement('span');
          text.innerText = `${a.type || 'Alert'} — ${src} ${a.timestamp? '('+a.timestamp+')':''}`;

          li.appendChild(text);

          // Only show block checkbox if user can modify IPs
          if (src !== 'unknown' && canModifyIPs) {
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.style.marginLeft = '12px';
            cb.checked = blockedSet.has(src);
            cb.onchange = function() {
              const checked = cb.checked;
              const url = checked ? '/block-ip/' : '/unblock-ip/';
              const reason = a.type || 'detected';
              // if OS blocking is enabled, require confirmation modal
              if (data.os_blocking_enabled) {
                const action = checked ? 'Block' : 'Unblock';
                showConfirmModal(action + ' IP', `${action} ${src} at OS level? This will modify the host firewall.`, {url, ip: src, checked, reason});
              } else {
                const form = new FormData();
                form.append('ip', src);
                if (checked) form.append('reason', reason);
                fetch(url, {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                  .then(r => r.json())
                  .then(j => {
                    if (!j.ok) { alert('Action failed: ' + (j.error || 'unknown')); cb.checked = !checked; }
                    else { updateBlockedIPs(src, checked, reason); }
                  }).catch(e => { alert('Request failed'); cb.checked = !checked; });
              }
            };
            li.appendChild(cb);
          }

          recentAlertsList.appendChild(li);
        });
      } else {
        recentAlertsList.innerHTML = '<li>No alerts yet</li>';
      }

      // Blocked IPs panel - with action buttons for admin/analyst
      const blockedIPsContainer = document.getElementById('blockedIPsContainer');
      blockedIPsContainer.innerHTML = '';
      
      if (data.blocked_ips && data.blocked_ips.length) {
        document.getElementById('blockedCountBadge').innerText = data.blocked_ips.length;
        
        data.blocked_ips.forEach(b => {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'background:rgba(30,41,59,0.6); padding:12px; border-radius:10px; border-left:3px solid #ef4444; display:flex; justify-content:space-between; align-items:center;';
          
          // IP Info Section
          const infoDiv = document.createElement('div');
          infoDiv.style.cssText = 'flex:1; min-width:0;';
          
          const ipSpan = document.createElement('div');
          ipSpan.style.cssText = 'font-weight:bold; color:#fbbf24; word-break:break-all;';
          ipSpan.innerText = b.ip;
          infoDiv.appendChild(ipSpan);
          
          const reasonSpan = document.createElement('div');
          reasonSpan.style.cssText = 'font-size:12px; color:#9ca3af; margin-top:4px;';
          reasonSpan.innerText = `Reason: ${b.reason || 'manual'} — ${b.created_at? new Date(b.created_at).toLocaleDateString() : 'unknown'}`;
          infoDiv.appendChild(reasonSpan);
          
          itemDiv.appendChild(infoDiv);
          
          // Action Buttons (only for admin/analyst)
          if (canModifyIPs) {
            const actionDiv = document.createElement('div');
            actionDiv.style.cssText = 'display:flex; gap:6px; margin-left:12px;';
            
            // Unblock Button
            const unblockBtn = document.createElement('button');
            unblockBtn.innerText = 'Unblock';
            unblockBtn.style.cssText = 'background:#10b981; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:12px; font-weight:bold; transition:background 0.2s;';
            unblockBtn.onmouseover = () => unblockBtn.style.background = '#059669';
            unblockBtn.onmouseout = () => unblockBtn.style.background = '#10b981';
            unblockBtn.onclick = () => {
              if (data.os_blocking_enabled) {
                showConfirmModal('Unblock IP', `Remove OS-level block for ${b.ip}?`, {url:'/unblock-ip/', ip: b.ip, checked:false});
              } else {
                const form = new FormData();
                form.append('ip', b.ip);
                fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                  .then(r => r.json())
                  .then(j => {
                    if (j.ok) { 
                      itemDiv.style.opacity = '0.5';
                      setTimeout(() => itemDiv.remove(), 300);
                      updateBlockedIPCount();
                    } else { 
                      alert('Unblock failed: ' + (j.error || 'unknown')); 
                    }
                  })
                  .catch(e => { alert('Request failed'); });
              }
            };
            actionDiv.appendChild(unblockBtn);
            
            // Close Button
            const closeBtn = document.createElement('button');
            closeBtn.innerText = '✕';
            closeBtn.style.cssText = 'background:#6b7280; color:white; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; font-size:14px; font-weight:bold; transition:background 0.2s;';
            closeBtn.onmouseover = () => closeBtn.style.background = '#4b5563';
            closeBtn.onmouseout = () => closeBtn.style.background = '#6b7280';
            closeBtn.onclick = () => {
              const form = new FormData();
              form.append('ip', b.ip);
              fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                .then(r => r.json())
                .then(j => {
                  if (j.ok) {
                    itemDiv.style.transform = 'slideOut';
                    itemDiv.style.opacity = '0';
                    setTimeout(() => itemDiv.remove(), 200);
                    updateBlockedIPCount();
                  }
                })
                .catch();
            };
            actionDiv.appendChild(closeBtn);
            
            itemDiv.appendChild(actionDiv);
          }
          
          blockedIPsContainer.appendChild(itemDiv);
        });
      } else {
        document.getElementById('blockedCountBadge').innerText = '0';
        blockedIPsContainer.innerHTML = '<div class="text-gray-400 text-center py-8">No blocked IPs</div>';
      }
      
      function updateBlockedIPCount() {
        const count = blockedIPsContainer.querySelectorAll('[style*="background:rgba"]').length;
        document.getElementById('blockedCountBadge').innerText = count;
        if (count === 0) {
          blockedIPsContainer.innerHTML = '<div class="text-gray-400 text-center py-8">No blocked IPs</div>';
        }
      }

      function updateBlockedIPs(ip, add, reason) {
        const blockedIPsContainer = document.getElementById('blockedIPsContainer');
        const countBadge = document.getElementById('blockedCountBadge');
        
        if (add) {
          // Add new blocked IP to the top
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'background:rgba(30,41,59,0.6); padding:12px; border-radius:10px; border-left:3px solid #ef4444; display:flex; justify-content:space-between; align-items:center;';
          
          const infoDiv = document.createElement('div');
          infoDiv.style.cssText = 'flex:1; min-width:0;';
          
          const ipSpan = document.createElement('div');
          ipSpan.style.cssText = 'font-weight:bold; color:#fbbf24; word-break:break-all;';
          ipSpan.innerText = ip;
          infoDiv.appendChild(ipSpan);
          
          const reasonSpan = document.createElement('div');
          reasonSpan.style.cssText = 'font-size:12px; color:#9ca3af; margin-top:4px;';
          reasonSpan.innerText = `Reason: ${reason || 'detected'} — ${new Date().toLocaleDateString()}`;
          infoDiv.appendChild(reasonSpan);
          
          itemDiv.appendChild(infoDiv);
          
          if (canModifyIPs) {
            const actionDiv = document.createElement('div');
            actionDiv.style.cssText = 'display:flex; gap:6px; margin-left:12px;';
            
            const unblockBtn = document.createElement('button');
            unblockBtn.innerText = 'Unblock';
            unblockBtn.style.cssText = 'background:#10b981; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:12px; font-weight:bold;';
            unblockBtn.onclick = () => {
              const form = new FormData();
              form.append('ip', ip);
              fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                .then(r => r.json())
                .then(j => { if (j.ok) { itemDiv.remove(); updateBlockedIPCount(); } })
                .catch();
            };
            actionDiv.appendChild(unblockBtn);
            
            const closeBtn = document.createElement('button');
            closeBtn.innerText = '✕';
            closeBtn.style.cssText = 'background:#6b7280; color:white; padding:6px 10px; border-radius:6px; border:none; cursor:pointer;';
            closeBtn.onclick = () => {
              const form = new FormData();
              form.append('ip', ip);
              fetch('/unblock-ip/', {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
                .then(r => r.json())
                .then(j => { if (j.ok) { itemDiv.remove(); updateBlockedIPCount(); } })
                .catch();
            };
            actionDiv.appendChild(closeBtn);
            itemDiv.appendChild(actionDiv);
          }
          
          blockedIPsContainer.prepend(itemDiv);
          if (blockedIPsContainer.querySelector('.text-gray-400')) {
            blockedIPsContainer.querySelector('.text-gray-400').remove();
          }
          updateBlockedIPCount();
        } else {
          // Remove IP from list
          const items = Array.from(blockedIPsContainer.querySelectorAll('div'));
          items.forEach(item => {
            const ipDiv = item.querySelector('[style*="color:#fbbf24"]');
            if (ipDiv && ipDiv.innerText === ip) {
              item.remove();
            }
          });
          updateBlockedIPCount();
        }
      }

      // Render AI/ML Attack Detections
      const attackDetectionList = document.getElementById('attackDetectionList');
      attackDetectionList.innerHTML = '';
      
      if (data.attack_detections && data.attack_detections.length) {
        document.getElementById('detectionCountBadge').innerText = data.attack_detections.length;
        
        // Calculate statistics
        let totalAttacks = data.attack_detections.length;
        let criticalCount = 0;
        let totalConfidence = 0;
        
        data.attack_detections.forEach(attack => {
          if (attack.severity === 'CRITICAL') criticalCount++;
          totalConfidence += attack.confidence_score;
          
          const attackDiv = document.createElement('div');
          attackDiv.style.cssText = 'background:rgba(30,41,59,0.8); padding:12px; border-radius:8px; border-left:4px solid; margin-bottom:8px;';
          
          // Determine color based on severity
          const severityColors = {
            'CRITICAL': '#ef4444',
            'HIGH': '#f97316',
            'MEDIUM': '#eab308',
            'LOW': '#3b82f6'
          };
          attackDiv.style.borderColor = severityColors[attack.severity] || '#3b82f6';
          
          // Build attack info
          const infoHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div style="flex:1;">
                <div style="font-weight:bold; color:${severityColors[attack.severity]}; margin-bottom:4px;">
                  ${attack.attack_type} - ${attack.severity}
                </div>
                <div style="font-size:12px; color:#9ca3af; margin-bottom:4px;">
                  Source: <span style="color:#fbbf24; font-weight:bold;">${attack.source_ip || 'N/A'}</span>
                  ${attack.port ? '| Port: ' + attack.port : ''}
                </div>
                <div style="font-size:11px; color:#6b7280;">
                  Model: ${attack.ai_model || 'Unknown'} | Time: ${new Date(attack.detected_at).toLocaleTimeString()}
                </div>
              </div>
              <div style="text-align:right;">
                <div style="background:#1e293b; padding:6px 10px; border-radius:6px; color:#60a5fa; font-weight:bold; font-size:12px;">
                  ${(attack.confidence_score * 100).toFixed(1)}% Confidence
                </div>
              </div>
            </div>
          `;
          
          attackDiv.innerHTML = infoHTML;
          attackDetectionList.appendChild(attackDiv);
        });
        
        // Update statistics
        document.getElementById('totalAttacks24h').innerText = totalAttacks;
        document.getElementById('avgConfidence').innerText = ((totalConfidence / totalAttacks) * 100).toFixed(1) + '%';
        document.getElementById('criticalThreats').innerText = criticalCount;
      } else {
        document.getElementById('detectionCountBadge').innerText = '0';
        document.getElementById('totalAttacks24h').innerText = '0';
        document.getElementById('avgConfidence').innerText = '0%';
        document.getElementById('criticalThreats').innerText = '0';
        attackDetectionList.innerHTML = '<div class="text-gray-400 text-center py-8">No attacks detected yet</div>';
      }

      // Confirm modal button handlers
      document.getElementById('confirmModalConfirm').onclick = function() {
        const btn = document.getElementById('confirmModalConfirm');
        const params = JSON.parse(btn.dataset.params || '{}');
        const url = params.url;
        const ip = params.ip;
        const checked = params.checked;
        const reason = params.reason || '';
        const form = new FormData(); form.append('ip', ip); if (checked) form.append('reason', reason);
        fetch(url, {method:'POST', body: form, headers: {'X-CSRFToken': getCookie('csrftoken')}})
          .then(r => r.json()).then(j => {
            if (!j.ok) { alert('Action failed: ' + (j.error || 'unknown')); }
            else { updateBlockedIPs(ip, checked, reason); }
          }).catch(e => { alert('Request failed'); })
          .finally(() => hideConfirmModal());
      };
      document.getElementById('confirmModalCancel').onclick = function() { hideConfirmModal(); };
    });
}

// AI detection
function showToast(){ aiToast.style.display="block"; }
function closeToast(){ aiToast.style.display="none"; }
function acknowledgeAlert(){ closeToast(); }

setInterval(() => {
    fetch('/ai-check/')
    .then(res => res.json())
    .then(data => {
        if (data.prediction === "ATTACK") {
            showToast();
        }

        document.getElementById("activeAlerts").innerText = data.alerts;
        document.getElementById("networkTraffic").innerText = data.traffic + " GB";
    });
}, 5000);

updateDashboard();
setInterval(updateDashboard, 5000);

// ==================== USER MANAGEMENT FUNCTIONS ====================
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

function loadUsers() {
  {% if user_role == 'ADMIN' or user_role == 'ANALYST' %}
  fetch('/api/users/')
    .then(r => r.json())
    .then(data => {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      if (data.users && data.users.length > 0) {
        data.users.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.className = 'flex justify-between items-center p-3 bg-slate-600/50 rounded-lg border border-gray-600';
          
          const roleColor = user.role === 'ADMIN' ? 'text-red-400' : user.role === 'ANALYST' ? 'text-yellow-400' : 'text-blue-400';
          const roleIcon = user.role === 'ADMIN' ? 'fas fa-crown' : user.role === 'ANALYST' ? 'fas fa-magnifying-glass' : 'fas fa-eye';
          
          userDiv.innerHTML = `
            <div>
              <p class="font-semibold text-white">${user.email}</p>
              <p class="text-xs text-gray-400">${user.name || 'User'}</p>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded text-xs font-semibold ${roleColor}">
                <i class="${roleIcon}"></i> ${user.role}
              </span>
              {% if user_role == 'ADMIN' %}
              <button onclick="removeUser('${user.id}')" class="px-2 py-1 bg-red-600/30 hover:bg-red-600/50 text-red-300 rounded text-xs transition">
                <i class="fas fa-trash"></i>
              </button>
              {% endif %}
            </div>
          `;
          usersList.appendChild(userDiv);
        });
      } else {
        usersList.innerHTML = '<div class="text-center text-gray-400 py-4">No users found</div>';
      }
    })
    .catch(e => {
      console.log('Error loading users:', e);
      document.getElementById('usersList').innerHTML = '<div class="text-center text-red-400 py-4">Error loading users</div>';
    });
  {% endif %}
}

function addNewUser() {
  {% if user_role == 'ADMIN' or user_role == 'ANALYST' %}
  const email = document.getElementById('newUserEmail').value.trim();
  const role = document.getElementById('newUserRole').value;
  
  if (!email || !role) {
    alert('Please fill in all fields');
    return;
  }
  
  // Analyst can only assign ANALYST and VIEWER roles
  {% if user_role == 'ANALYST' %}
  if (role === 'ADMIN') {
    alert('You can only assign Analyst and Viewer roles.');
    return;
  }
  {% endif %}
  
  const formData = new FormData();
  formData.append('email', email);
  formData.append('role', role);
  
  fetch('/api/add-user/', {
    method: 'POST',
    body: formData,
    headers: {'X-CSRFToken': getCookie('csrftoken')}
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showNotification(`User added successfully!`, 'success');
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserRole').value = '';
      loadUsers();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(e => alert('Error adding user: ' + e));
  {% endif %}
}

function removeUser(userId) {
  if (!confirm('Are you sure you want to remove this user?')) return;
  
  fetch('/api/remove-user/', {
    method: 'POST',
    body: JSON.stringify({user_id: userId}),
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showNotification('User removed successfully!', 'success');
      loadUsers();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(e => alert('Error removing user: ' + e));
}

function showNotification(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `animate-fade fixed top-6 right-6 px-6 py-3 rounded-lg text-white font-semibold z-50`;
  toast.style.maxWidth = '400px';
  
  if (type === 'success') {
    toast.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-500');
  } else if (type === 'error') {
    toast.classList.add('bg-gradient-to-r', 'from-red-500', 'to-pink-500');
  } else {
    toast.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-cyan-500');
  }
  
  toast.innerText = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 4000);
}

// Load users on page load if admin or analyst
{% if user_role == 'ADMIN' or user_role == 'ANALYST' %}
loadUsers();
{% endif %}

// WebSocket real-time updates
(function(){
  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(protocol + '://' + window.location.host + '/ws/alerts/');
  ws.onopen = () => console.log('ws open');
  ws.onmessage = (evt) => {
    try {
      const data = JSON.parse(evt.data);
      // If new alert, prepend to recent alerts
      if (data && data.attack_type) {
        const recentAlertsList = document.getElementById('recentAlertsList');
        const li = document.createElement('li');
        const src = data.source || 'unknown';
        li.innerText = `${data.attack_type} — ${src} (${data.timestamp || new Date().toISOString()})`;
        // add checkbox for blocking
        if (src !== 'unknown') {
          const cb = document.createElement('input'); cb.type='checkbox'; cb.style.marginLeft='12px';
          cb.onchange = function(){ /* user can use existing UI to block */ };
          li.appendChild(cb);
        }
        recentAlertsList.prepend(li);
        // also update activeAlerts counter
        const el = document.getElementById('activeAlerts');
        if (el) el.innerText = parseInt(el.innerText || '0') + 1;
      }
      // If blocked event, update blocked IPs
      if (data && data.blocked && data.source) {
        const blockedIPsList = document.getElementById('blockedIPsList');
        const li = document.createElement('li');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.style.marginRight='8px';
        const span = document.createElement('span'); span.innerText = `${data.source} — blocked (${new Date().toISOString()})`;
        li.appendChild(cb); li.appendChild(span);
        blockedIPsList.prepend(li);
      }
    } catch(e) { console.error('ws msg err', e); }
  };
  ws.onclose = () => console.log('ws closed');
})();
</script>

</body>
</html>
